{#
 # @param string onLoginHandler [optional]
 # @param string onLogoutHandler [optional]
 # @param string onLogoutParams [optional]
 #}

{% set apiKey = gigya_socializer.apiKey %}
{% set namespace = gigya_socializer.namespace %}
{% set signOnFunctionPrefix = gigya_socializer.getSignOnFunctionPrefix() %}

<script type="text/javascript">
{% if namespace != 'window' %}
if ({{ namespace }} == null || typeof({{ namespace }}) != 'object') { var {{ namespace }} = window.{{ namespace }} = {}; }
{% endif %}

;(function($){
    {{ namespace }}.registerSignOnHandlers = function() {
        if (typeof gigya != 'undefined') {
            if (typeof console != 'undefined') console.log('Gigya instantiated');
            gigya.services.socialize.addEventHandlers(conf, {
                context: { str: 'single_sign_on' }
                {% if onLoginHandler %}
                , onLogin: onLoginHandler
                {% else %}
                , onLogin: {{ namespace }}.onLoginHandler
                {% endif %}
                {% if onLogoutHandler %}             
                , onLogout: onLoginHandler
                {% else %}
                , onLogout: {{ namespace }}.onLogoutHandler
                {% endif %}
             });
        } else {
            if (typeof console != 'undefined') console.log("Gigya:\n-- typeof gigya == "+typeof gigya+"\n-- Reattempting instantiation in 100 milliseconds");
        	setTimeout(function(){
            	{{ namespace }}.registerSignOnHandlers();
        	},100);
    	}
    }

    {% if not onLoginHandler %}
    {{ namespace }}.onLoginHandler = function(eventObj) {
        if (typeof console != 'undefined') console.log("Gigya:\n-- typeof gigya == "+typeof gigya+"\n-- onLoginHandler executed");

        if (typeof console != 'undefined') {
            var consoleOutput = "Gigya:";
            consoleOutput += "\n-- context == "+ eventObj.context.str;
            consoleOutput += "\n-- eventName == "+ eventObj.eventName;
            consoleOutput += "\n-- provider == "+ eventObj.provider;
            consoleOutput += "\n-- providerUID == "+ eventObj.user.identities[eventObj.provider].providerUID;

            console.log(consoleOutput);
        }

        var conf = {
            APIKey: '{{ apiKey }}'
        };

        var newUser = false;
        var hasEmail = false;
        var identities = eventObj.user.identities;

        // Check if user exists
        var localUser = {{ namespace }}.getLocalUser(identities);

        // If user exists, map provider UID to user

        // If user does not exist, create if provider has email


        var hasEmail = false;
        if (newUser && typeof localUserUID != 'undefined' && typeof dateStr != 'undefined' && typeof localSignature != 'undefined') {
            // 1. Register user 
            // 2. Store new user in DB
            // 3. link site account to social network identity
            //   3.1 first construct the linkAccounts parameters

            var params = {
                siteUID: localUserUID, 
                timestamp: dateStr,
			    cid: 'sign_on_link_account',
                signature: localSignature
            };

            //   3.1 call linkAccounts method:
            gigya.services.socialize.notifyRegistration(conf, params);
        }
    }
    {% endif %}

    {% if not onLogoutHandler %}
    {{ namespace }}.onLogoutHandler = function() {
        if (typeof console != 'undefined') console.log("Gigya:\n-- typeof gigya == "+typeof gigya+"\n-- onLogoutHandler executed");

        var conf = {
            APIKey: '{{ apiKey }}'
        };

        {% if onLogoutParams %}
        gigya.services.socialize.logout(conf, {{ onLogoutParams }} );
        {% else %}
        gigya.services.socialize.logout(conf, {}); 
        {% endif %}
    }
    {% endif %}

    {{ namespace }}.getLocalUser = function(identities) {
        var input = {
            'providers': identities
        };

        $.ajax({
            type: "POST",
            url: {{ path('gigya_user_find_by_providers') }},
            data: input,
            dataType: 'json',
            success: function(data) {
                if (typeof console != 'undefined') console.log("Gigya:\n-- get Local User == success");
            },
            error: function(request, textStatus, errorThrown) {
                if (typeof console != 'undefined') console.log("Gigya:\n-- get Local User == error\n -- status == "+ textStatus);
            }
        });        
    }
})(jQuery);
</script>
